# فلترة رسائل البوت (Chatbot Message Filtering)

## 📋 المشكلة

عند تحميل تاريخ المحادثات من الخادم، كانت رسائل المستخدم تحتوي على نص إضافي من النظام:

```
معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في قاعده البيانات
```

هذا النص يُضاف إلى كل رسالة مستخدم قبل إرسالها للـ AI لتوجيهه، ولكن يجب إزالته عند عرض الرسائل للمستخدم في الواجهة.

---

## ✅ الحل المطبق

تم إضافة نظام فلترة تلقائي لتنظيف رسائل المستخدم عند تحميل التاريخ.

### الملف المعدل:
**المسار**: `/front-end/src/contexts/ChatbotContext.tsx`

---

## 🔧 التنفيذ

### 1. **دوال التنظيف**:

تم إضافة دالتين مساعدتين:

#### أ) `cleanMessageContent`:
```typescript
const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    // إزالة نص النظام من رسائل المستخدم
    const cleanedContent = message.content.replace(
      /معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في\s*قاعده البيانات/g,
      ''
    ).trim();
    
    return {
      ...message,
      content: cleanedContent
    };
  }
  return message;
};
```

**الوظيفة**:
- تفحص إذا كانت الرسالة من المستخدم (`role === 'user'`)
- تستخدم regex لإزالة نص النظام
- تقوم بـ `trim()` لإزالة المسافات الزائدة
- ترجع رسالة البوت كما هي بدون تعديل

#### ب) `cleanMessages`:
```typescript
const cleanMessages = (messages: ChatMessage[]): ChatMessage[] => {
  return messages.map(cleanMessageContent);
};
```

**الوظيفة**:
- تطبق `cleanMessageContent` على كل رسالة في المصفوفة

---

### 2. **تطبيق الفلترة**:

تم تطبيق التنظيف في 3 أماكن:

#### أ) عند التحقق من الجلسة النشطة:
```typescript
useEffect(() => {
  const checkActiveSession = async () => {
    if (chatbotService.hasActiveSession()) {
      try {
        const history = await chatbotService.getChatHistory();
        
        // تنظيف الرسائل قبل عرضها
        const cleanedMessages = cleanMessages(history.messages.messages);
        
        dispatch({ type: 'SET_MESSAGES', payload: cleanedMessages });
      } catch (error) {
        // معالجة الأخطاء
      }
    }
  };
  checkActiveSession();
}, []);
```

#### ب) في دالة تحميل التاريخ:
```typescript
const loadChatHistory = useCallback(async () => {
  try {
    const history = await chatbotService.getChatHistory();
    
    // تنظيف الرسائل قبل عرضها
    const cleanedMessages = cleanMessages(history.messages.messages);
    
    dispatch({ type: 'SET_MESSAGES', payload: cleanedMessages });
  } catch (error) {
    // معالجة الأخطاء
  }
}, []);
```

#### ج) الرسائل الجديدة:
الرسائل الجديدة التي يكتبها المستخدم **لا تحتاج** إلى تنظيف لأنها:
1. تُعرض محلياً بدون النص الإضافي (السطر 216-222)
2. النص الإضافي يُضاف فقط عند الإرسال للخادم (السطر 229)

---

## 📊 سير العمل

### 1. **المستخدم يكتب رسالة**:
```
"أريد شراء صابون"
```

### 2. **الرسالة تُعرض محلياً**:
```
المستخدم: "أريد شراء صابون"
```

### 3. **الرسالة تُرسل للخادم**:
```
"أريد شراء صابون معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في قاعده البيانات"
```

### 4. **الرسالة تُحفظ في قاعدة البيانات**:
```
user: "أريد شراء صابون معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في قاعده البيانات"
```

### 5. **عند تحميل التاريخ**:
```typescript
// الرسالة الأصلية من قاعدة البيانات
{
  role: 'user',
  content: "أريد شراء صابون معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في قاعده البيانات"
}

// بعد التنظيف
{
  role: 'user',
  content: "أريد شراء صابون"
}
```

---

## 🎯 المزايا

### ✅ 1. **تجربة مستخدم أفضل**:
- المستخدم لا يرى نصوص النظام الداخلية
- المحادثة تبدو طبيعية

### ✅ 2. **عدم التأثير على وظيفة AI**:
- النص لا يزال يُرسل للـ AI للتوجيه
- فقط العرض يتم تنظيفه

### ✅ 3. **تنظيف تلقائي**:
- يعمل على جميع الرسائل القديمة
- لا يحتاج إلى تدخل يدوي

### ✅ 4. **كود نظيف**:
- دوال مساعدة قابلة لإعادة الاستخدام
- سهل الصيانة والتوسع

---

## 🔍 التفاصيل التقنية

### Regex المستخدم:
```javascript
/معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في\s*قاعده البيانات/g
```

**الشرح**:
- يبحث عن النص بالضبط
- `\s*` يطابق صفر أو أكثر من المسافات البيضاء
- `g` flag للبحث عن جميع التطابقات (global)

### لماذا `\s*` ؟
لأن النص قد يحتوي على:
- مسافة واحدة: `قاعده البيانات`
- عدة مسافات: `قاعده  البيانات`
- سطر جديد: `قاعده\nالبيانات`

---

## 🧪 الاختبار

### سيناريو 1: رسالة عادية
**المدخل**:
```json
{
  "role": "user",
  "content": "مرحباً"
}
```

**المخرج**:
```json
{
  "role": "user",
  "content": "مرحباً"
}
```

### سيناريو 2: رسالة مع نص النظام
**المدخل**:
```json
{
  "role": "user",
  "content": "كيف حالكممعلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في قاعده البيانات"
}
```

**المخرج**:
```json
{
  "role": "user",
  "content": "كيف حالكم"
}
```

### سيناريو 3: رسالة البوت
**المدخل**:
```json
{
  "role": "assistant",
  "content": "أهلاً بك! يمكنني مساعدتك في اختيار المنتج المناسب."
}
```

**المخرج** (بدون تغيير):
```json
{
  "role": "assistant",
  "content": "أهلاً بك! يمكنني مساعدتك في اختيار المنتج المناسب."
}
```

---

## 🔄 الأماكن التي يتم فيها التنظيف

### ✅ يتم التنظيف في:
1. عند تحميل التاريخ من الخادم
2. عند التحقق من الجلسة النشطة
3. عند استدعاء `loadChatHistory()` يدوياً

### ❌ لا يتم التنظيف في:
1. رسائل المستخدم الجديدة (لأنها نظيفة بالفعل)
2. رسائل البوت (لا تحتوي على النص)
3. قاعدة البيانات (البيانات الأصلية تبقى كما هي)

---

## 📝 ملاحظات مهمة

### 1. **البيانات في قاعدة البيانات**:
- لا يتم تعديل البيانات في قاعدة البيانات
- التنظيف يحدث فقط عند العرض (Client-side)
- البيانات الأصلية تبقى محفوظة

### 2. **الأداء**:
- التنظيف يتم مرة واحدة عند التحميل
- لا يؤثر على أداء المحادثات النشطة
- استخدام `map()` فعال للمصفوفات

### 3. **التوافقية**:
- يعمل مع جميع المتصفحات الحديثة
- Regex مدعوم بالكامل
- لا حاجة لـ polyfills

---

## 🚀 التحسينات المستقبلية

### يمكن إضافة:

1. **تنظيف نصوص نظام إضافية**:
```typescript
const systemPatterns = [
  /معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في\s*قاعده البيانات/g,
  /نص نظام آخر/g,
  // المزيد من الأنماط
];

const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    let content = message.content;
    systemPatterns.forEach(pattern => {
      content = content.replace(pattern, '').trim();
    });
    return { ...message, content };
  }
  return message;
};
```

2. **تخزين الأنماط في ملف منفصل**:
```typescript
// constants/systemMessages.ts
export const SYSTEM_MESSAGE_PATTERNS = {
  PRODUCT_WARNING: /معلومات من النظام: يجب دائما عدم ذكر اي منتج غير موجود في\s*قاعده البيانات/g,
  // المزيد...
};
```

3. **إضافة logging**:
```typescript
const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    const original = message.content;
    const cleaned = original.replace(/* ... */);
    
    if (original !== cleaned) {
      console.debug('Cleaned system text from message:', {
        original: original.substring(0, 50),
        cleaned: cleaned.substring(0, 50)
      });
    }
    
    return { ...message, content: cleaned };
  }
  return message;
};
```

---

## 🐛 استكشاف الأخطاء

### المشكلة: النص لا يزال يظهر

**الحلول**:
1. تأكد من إعادة تحميل الصفحة
2. امسح cache المتصفح
3. تأكد من صحة الـ regex pattern

### المشكلة: الرسائل فارغة

**الحلول**:
1. تحقق من وجود `trim()` بعد `replace()`
2. تأكد من أن الرسالة لا تحتوي فقط على نص النظام

### المشكلة: بطء في التحميل

**الحلول**:
1. Regex محسن بالفعل
2. التنظيف يحدث مرة واحدة عند التحميل
3. لا يؤثر على الأداء بشكل ملحوظ

---

## 📞 الدعم الفني

إذا واجهت أي مشكلة:
1. تحقق من console.log للأخطاء
2. تأكد من تحديث `ChatbotContext.tsx`
3. تحقق من نسخة React (يجب أن تدعم Hooks)

---

تم التحديث: 23 أكتوبر 2025
الإصدار: 1.0.0

