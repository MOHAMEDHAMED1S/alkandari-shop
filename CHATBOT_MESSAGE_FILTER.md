# ููุชุฑุฉ ุฑุณุงุฆู ุงูุจูุช (Chatbot Message Filtering)

## ๐ ุงููุดููุฉ

ุนูุฏ ุชุญููู ุชุงุฑูุฎ ุงููุญุงุฏุซุงุช ูู ุงูุฎุงุฏูุ ูุงูุช ุฑุณุงุฆู ุงููุณุชุฎุฏู ุชุญุชูู ุนูู ูุต ุฅุถุงูู ูู ุงููุธุงู:

```
ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏู ุงูุจูุงูุงุช
```

ูุฐุง ุงููุต ููุถุงู ุฅูู ูู ุฑุณุงูุฉ ูุณุชุฎุฏู ูุจู ุฅุฑุณุงููุง ููู AI ูุชูุฌูููุ ูููู ูุฌุจ ุฅุฒุงูุชู ุนูุฏ ุนุฑุถ ุงูุฑุณุงุฆู ูููุณุชุฎุฏู ูู ุงููุงุฌูุฉ.

---

## โ ุงูุญู ุงููุทุจู

ุชู ุฅุถุงูุฉ ูุธุงู ููุชุฑุฉ ุชููุงุฆู ูุชูุธูู ุฑุณุงุฆู ุงููุณุชุฎุฏู ุนูุฏ ุชุญููู ุงูุชุงุฑูุฎ.

### ุงูููู ุงููุนุฏู:
**ุงููุณุงุฑ**: `/front-end/src/contexts/ChatbotContext.tsx`

---

## ๐ง ุงูุชูููุฐ

### 1. **ุฏูุงู ุงูุชูุธูู**:

ุชู ุฅุถุงูุฉ ุฏุงูุชูู ูุณุงุนุฏุชูู:

#### ุฃ) `cleanMessageContent`:
```typescript
const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    // ุฅุฒุงูุฉ ูุต ุงููุธุงู ูู ุฑุณุงุฆู ุงููุณุชุฎุฏู
    const cleanedContent = message.content.replace(
      /ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู\s*ูุงุนุฏู ุงูุจูุงูุงุช/g,
      ''
    ).trim();
    
    return {
      ...message,
      content: cleanedContent
    };
  }
  return message;
};
```

**ุงููุธููุฉ**:
- ุชูุญุต ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู (`role === 'user'`)
- ุชุณุชุฎุฏู regex ูุฅุฒุงูุฉ ูุต ุงููุธุงู
- ุชููู ุจู `trim()` ูุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
- ุชุฑุฌุน ุฑุณุงูุฉ ุงูุจูุช ููุง ูู ุจุฏูู ุชุนุฏูู

#### ุจ) `cleanMessages`:
```typescript
const cleanMessages = (messages: ChatMessage[]): ChatMessage[] => {
  return messages.map(cleanMessageContent);
};
```

**ุงููุธููุฉ**:
- ุชุทุจู `cleanMessageContent` ุนูู ูู ุฑุณุงูุฉ ูู ุงููุตูููุฉ

---

### 2. **ุชุทุจูู ุงูููุชุฑุฉ**:

ุชู ุชุทุจูู ุงูุชูุธูู ูู 3 ุฃูุงูู:

#### ุฃ) ุนูุฏ ุงูุชุญูู ูู ุงูุฌูุณุฉ ุงููุดุทุฉ:
```typescript
useEffect(() => {
  const checkActiveSession = async () => {
    if (chatbotService.hasActiveSession()) {
      try {
        const history = await chatbotService.getChatHistory();
        
        // ุชูุธูู ุงูุฑุณุงุฆู ูุจู ุนุฑุถูุง
        const cleanedMessages = cleanMessages(history.messages.messages);
        
        dispatch({ type: 'SET_MESSAGES', payload: cleanedMessages });
      } catch (error) {
        // ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
      }
    }
  };
  checkActiveSession();
}, []);
```

#### ุจ) ูู ุฏุงูุฉ ุชุญููู ุงูุชุงุฑูุฎ:
```typescript
const loadChatHistory = useCallback(async () => {
  try {
    const history = await chatbotService.getChatHistory();
    
    // ุชูุธูู ุงูุฑุณุงุฆู ูุจู ุนุฑุถูุง
    const cleanedMessages = cleanMessages(history.messages.messages);
    
    dispatch({ type: 'SET_MESSAGES', payload: cleanedMessages });
  } catch (error) {
    // ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
  }
}, []);
```

#### ุฌ) ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ:
ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ ุงูุชู ููุชุจูุง ุงููุณุชุฎุฏู **ูุง ุชุญุชุงุฌ** ุฅูู ุชูุธูู ูุฃููุง:
1. ุชูุนุฑุถ ูุญููุงู ุจุฏูู ุงููุต ุงูุฅุถุงูู (ุงูุณุทุฑ 216-222)
2. ุงููุต ุงูุฅุถุงูู ููุถุงู ููุท ุนูุฏ ุงูุฅุฑุณุงู ููุฎุงุฏู (ุงูุณุทุฑ 229)

---

## ๐ ุณูุฑ ุงูุนูู

### 1. **ุงููุณุชุฎุฏู ููุชุจ ุฑุณุงูุฉ**:
```
"ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู"
```

### 2. **ุงูุฑุณุงูุฉ ุชูุนุฑุถ ูุญููุงู**:
```
ุงููุณุชุฎุฏู: "ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู"
```

### 3. **ุงูุฑุณุงูุฉ ุชูุฑุณู ููุฎุงุฏู**:
```
"ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏู ุงูุจูุงูุงุช"
```

### 4. **ุงูุฑุณุงูุฉ ุชูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**:
```
user: "ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏู ุงูุจูุงูุงุช"
```

### 5. **ุนูุฏ ุชุญููู ุงูุชุงุฑูุฎ**:
```typescript
// ุงูุฑุณุงูุฉ ุงูุฃุตููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
{
  role: 'user',
  content: "ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏู ุงูุจูุงูุงุช"
}

// ุจุนุฏ ุงูุชูุธูู
{
  role: 'user',
  content: "ุฃุฑูุฏ ุดุฑุงุก ุตุงุจูู"
}
```

---

## ๐ฏ ุงููุฒุงูุง

### โ 1. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู**:
- ุงููุณุชุฎุฏู ูุง ูุฑู ูุตูุต ุงููุธุงู ุงูุฏุงุฎููุฉ
- ุงููุญุงุฏุซุฉ ุชุจุฏู ุทุจูุนูุฉ

### โ 2. **ุนุฏู ุงูุชุฃุซูุฑ ุนูู ูุธููุฉ AI**:
- ุงููุต ูุง ูุฒุงู ููุฑุณู ููู AI ููุชูุฌูู
- ููุท ุงูุนุฑุถ ูุชู ุชูุธููู

### โ 3. **ุชูุธูู ุชููุงุฆู**:
- ูุนูู ุนูู ุฌููุน ุงูุฑุณุงุฆู ุงููุฏููุฉ
- ูุง ูุญุชุงุฌ ุฅูู ุชุฏุฎู ูุฏูู

### โ 4. **ููุฏ ูุธูู**:
- ุฏูุงู ูุณุงุนุฏุฉ ูุงุจูุฉ ูุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู
- ุณูู ุงูุตูุงูุฉ ูุงูุชูุณุน

---

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### Regex ุงููุณุชุฎุฏู:
```javascript
/ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู\s*ูุงุนุฏู ุงูุจูุงูุงุช/g
```

**ุงูุดุฑุญ**:
- ูุจุญุซ ุนู ุงููุต ุจุงูุถุจุท
- `\s*` ูุทุงุจู ุตูุฑ ุฃู ุฃูุซุฑ ูู ุงููุณุงูุงุช ุงูุจูุถุงุก
- `g` flag ููุจุญุซ ุนู ุฌููุน ุงูุชุทุงุจูุงุช (global)

### ููุงุฐุง `\s*` ุ
ูุฃู ุงููุต ูุฏ ูุญุชูู ุนูู:
- ูุณุงูุฉ ูุงุญุฏุฉ: `ูุงุนุฏู ุงูุจูุงูุงุช`
- ุนุฏุฉ ูุณุงูุงุช: `ูุงุนุฏู  ุงูุจูุงูุงุช`
- ุณุทุฑ ุฌุฏูุฏ: `ูุงุนุฏู\nุงูุจูุงูุงุช`

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ุฑุณุงูุฉ ุนุงุฏูุฉ
**ุงููุฏุฎู**:
```json
{
  "role": "user",
  "content": "ูุฑุญุจุงู"
}
```

**ุงููุฎุฑุฌ**:
```json
{
  "role": "user",
  "content": "ูุฑุญุจุงู"
}
```

### ุณููุงุฑูู 2: ุฑุณุงูุฉ ูุน ูุต ุงููุธุงู
**ุงููุฏุฎู**:
```json
{
  "role": "user",
  "content": "ููู ุญุงููููุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏู ุงูุจูุงูุงุช"
}
```

**ุงููุฎุฑุฌ**:
```json
{
  "role": "user",
  "content": "ููู ุญุงููู"
}
```

### ุณููุงุฑูู 3: ุฑุณุงูุฉ ุงูุจูุช
**ุงููุฏุฎู**:
```json
{
  "role": "assistant",
  "content": "ุฃููุงู ุจู! ูููููู ูุณุงุนุฏุชู ูู ุงุฎุชูุงุฑ ุงูููุชุฌ ุงูููุงุณุจ."
}
```

**ุงููุฎุฑุฌ** (ุจุฏูู ุชุบููุฑ):
```json
{
  "role": "assistant",
  "content": "ุฃููุงู ุจู! ูููููู ูุณุงุนุฏุชู ูู ุงุฎุชูุงุฑ ุงูููุชุฌ ุงูููุงุณุจ."
}
```

---

## ๐ ุงูุฃูุงูู ุงูุชู ูุชู ูููุง ุงูุชูุธูู

### โ ูุชู ุงูุชูุธูู ูู:
1. ุนูุฏ ุชุญููู ุงูุชุงุฑูุฎ ูู ุงูุฎุงุฏู
2. ุนูุฏ ุงูุชุญูู ูู ุงูุฌูุณุฉ ุงููุดุทุฉ
3. ุนูุฏ ุงุณุชุฏุนุงุก `loadChatHistory()` ูุฏููุงู

### โ ูุง ูุชู ุงูุชูุธูู ูู:
1. ุฑุณุงุฆู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏุฉ (ูุฃููุง ูุธููุฉ ุจุงููุนู)
2. ุฑุณุงุฆู ุงูุจูุช (ูุง ุชุญุชูู ุนูู ุงููุต)
3. ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูุจูุงูุงุช ุงูุฃุตููุฉ ุชุจูู ููุง ูู)

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. **ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**:
- ูุง ูุชู ุชุนุฏูู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุงูุชูุธูู ูุญุฏุซ ููุท ุนูุฏ ุงูุนุฑุถ (Client-side)
- ุงูุจูุงูุงุช ุงูุฃุตููุฉ ุชุจูู ูุญููุธุฉ

### 2. **ุงูุฃุฏุงุก**:
- ุงูุชูุธูู ูุชู ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุชุญููู
- ูุง ูุคุซุฑ ุนูู ุฃุฏุงุก ุงููุญุงุฏุซุงุช ุงููุดุทุฉ
- ุงุณุชุฎุฏุงู `map()` ูุนุงู ูููุตูููุงุช

### 3. **ุงูุชูุงูููุฉ**:
- ูุนูู ูุน ุฌููุน ุงููุชุตูุญุงุช ุงูุญุฏูุซุฉ
- Regex ูุฏุนูู ุจุงููุงูู
- ูุง ุญุงุฌุฉ ูู polyfills

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### ูููู ุฅุถุงูุฉ:

1. **ุชูุธูู ูุตูุต ูุธุงู ุฅุถุงููุฉ**:
```typescript
const systemPatterns = [
  /ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู\s*ูุงุนุฏู ุงูุจูุงูุงุช/g,
  /ูุต ูุธุงู ุขุฎุฑ/g,
  // ุงููุฒูุฏ ูู ุงูุฃููุงุท
];

const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    let content = message.content;
    systemPatterns.forEach(pattern => {
      content = content.replace(pattern, '').trim();
    });
    return { ...message, content };
  }
  return message;
};
```

2. **ุชุฎุฒูู ุงูุฃููุงุท ูู ููู ูููุตู**:
```typescript
// constants/systemMessages.ts
export const SYSTEM_MESSAGE_PATTERNS = {
  PRODUCT_WARNING: /ูุนูููุงุช ูู ุงููุธุงู: ูุฌุจ ุฏุงุฆูุง ุนุฏู ุฐูุฑ ุงู ููุชุฌ ุบูุฑ ููุฌูุฏ ูู\s*ูุงุนุฏู ุงูุจูุงูุงุช/g,
  // ุงููุฒูุฏ...
};
```

3. **ุฅุถุงูุฉ logging**:
```typescript
const cleanMessageContent = (message: ChatMessage): ChatMessage => {
  if (message.role === 'user') {
    const original = message.content;
    const cleaned = original.replace(/* ... */);
    
    if (original !== cleaned) {
      console.debug('Cleaned system text from message:', {
        original: original.substring(0, 50),
        cleaned: cleaned.substring(0, 50)
      });
    }
    
    return { ...message, content: cleaned };
  }
  return message;
};
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงููุต ูุง ูุฒุงู ูุธูุฑ

**ุงูุญููู**:
1. ุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
2. ุงูุณุญ cache ุงููุชุตูุญ
3. ุชุฃูุฏ ูู ุตุญุฉ ุงูู regex pattern

### ุงููุดููุฉ: ุงูุฑุณุงุฆู ูุงุฑุบุฉ

**ุงูุญููู**:
1. ุชุญูู ูู ูุฌูุฏ `trim()` ุจุนุฏ `replace()`
2. ุชุฃูุฏ ูู ุฃู ุงูุฑุณุงูุฉ ูุง ุชุญุชูู ููุท ุนูู ูุต ุงููุธุงู

### ุงููุดููุฉ: ุจุทุก ูู ุงูุชุญููู

**ุงูุญููู**:
1. Regex ูุญุณู ุจุงููุนู
2. ุงูุชูุธูู ูุญุฏุซ ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุชุญููู
3. ูุง ูุคุซุฑ ุนูู ุงูุฃุฏุงุก ุจุดูู ููุญูุธ

---

## ๐ ุงูุฏุนู ุงูููู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุชุญูู ูู console.log ููุฃุฎุทุงุก
2. ุชุฃูุฏ ูู ุชุญุฏูุซ `ChatbotContext.tsx`
3. ุชุญูู ูู ูุณุฎุฉ React (ูุฌุจ ุฃู ุชุฏุนู Hooks)

---

ุชู ุงูุชุญุฏูุซ: 23 ุฃูุชูุจุฑ 2025
ุงูุฅุตุฏุงุฑ: 1.0.0

